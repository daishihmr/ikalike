var BulletML={};
(function(){function h(b){var a=new BulletML.Root,g=b.getElementsByTagName("bulletml")[0];if(g){k(g,"type",function(b){a.type=b});var d=g.getElementsByTagName("action");if(d)for(var b=0,f=d.length;b<f;b++){var r=m(a,d[b]);r&&(a.actions[a.actions.length]=r)}if(d=g.getElementsByTagName("bullet")){b=0;for(f=d.length;b<f;b++)(r=c(a,d[b]))&&(a.bullets[a.bullets.length]=r)}if(g=g.getElementsByTagName("fire")){b=0;for(f=g.length;b<f;b++)(d=e(a,g[b]))&&(a.fires[a.fires.length]=d)}return a}}function m(b,a){var g=
new BulletML.Action;k(a,"label",function(b){g.label=b});j(a,".",function(a){switch(a.tagName){case "action":g.commands[g.commands.length]=m(b,a);break;case "actionRef":g.commands[g.commands.length]=n(b,a);break;case "fire":g.commands[g.commands.length]=e(b,a);break;case "fireRef":var c=g.commands,i=g.commands.length,h=new BulletML.FireRef;k(a,"label",function(b){h.label=b});j(a,/param$/,function(b){h.params[h.params.length]=l(b)});h.root=b;c[i]=h;break;case "changeDirection":var c=g.commands,i=g.commands.length,
s=new BulletML.ChangeDirection;s.root=b;f(a,"direction",function(b){s.direction=d(new BulletML.Direction,b)});f(a,"term",function(b){s.term=l(b)});c[i]=s;break;case "changeSpeed":var c=g.commands,i=g.commands.length,t=new BulletML.ChangeSpeed;t.root=b;f(a,"speed",function(b){t.speed=d(new BulletML.Speed,b)});f(a,"term",function(b){t.term=l(b)});c[i]=t;break;case "accel":var c=g.commands,i=g.commands.length,p=new BulletML.Accel;p.root=b;f(a,"horizontal",function(b){p.horizontal=d(new BulletML.Horizontal,
b)});f(a,"vertical",function(b){p.vertical=d(new BulletML.Vertical,b)});f(a,"term",function(b){p.term=l(b)});c[i]=p;break;case "wait":var c=g.commands,i=g.commands.length,u=new BulletML.Wait;u.root=b;u.value=l(a);c[i]=u;break;case "vanish":a=g.commands;c=g.commands.length;i=new BulletML.Vanish;i.root=b;a[c]=i;break;case "repeat":var c=g.commands,i=g.commands.length,q=new BulletML.Repeat;f(a,"action",function(a){q.action=m(b,a)});f(a,"actionRef",function(a){q.action=n(b,a)});f(a,"times",function(b){q.times=
l(b)});q.root=b;c[i]=q}});g.root=b;return g}function n(b,a){var c=new BulletML.ActionRef;k(a,"label",function(b){c.label=b});j(a,/param$/,function(b){c.params[c.params.length]=l(b)});c.root=b;return c}function c(b,a){var c=new BulletML.Bullet;k(a,"label",function(b){c.label=b});f(a,"direction",function(b){c.direction=d(new BulletML.Direction,b)});f(a,"speed",function(b){c.speed=d(new BulletML.Speed,b)});j(a,/(action)|(actionRef)$/,function(a){"action"==a.tagName?c.actions[c.actions.length]=m(b,a):
"actionRef"==a.tagName&&(c.actions[c.actions.length]=n(b,a))});c.root=b;return c}function e(b,a){var g=new BulletML.Fire;k(a,"label",function(b){g.label=b});f(a,"direction",function(b){g.direction=d(new BulletML.Direction,b)});f(a,"speed",function(b){g.speed=d(new BulletML.Speed,b)});f(a,"bullet",function(a){g.bullet=c(b,a)});f(a,"bulletRef",function(a){var c=new BulletML.BulletRef;k(a,"label",function(b){c.label=b});j(a,/param$/,function(b){c.params[c.params.length]=l(b)});c.root=b;g.bullet=c});
if(!g.bullet)throw Error("fire has no bullet or bulletRef.");g.root=b;return g}function d(b,a){k(a,"type",function(a){b.type=a});l(a,function(a){b.value=a});return b}function a(b,a){for(var c=0,d=b.length;c<d;c++)if(b[c].label==a)return b[c]}function f(b,a,c,d){for(var b=b.childNodes,e=0,f=b.length;e<f;e++)if(b[e].tagName&&b[e].tagName==a)return c&&c(b[e]),c(b[e]);d&&d()}function j(b,a,c){for(var b=b.childNodes,d=0,e=b.length;d<e;d++)b[d].tagName&&b[d].tagName.match(a)&&c(b[d])}function k(b,a,c,d){if(b=
b.attributes[a])return c&&c(b.value),b;d&&d()}function l(b,a){var c=b.textContent;if(void 0!==c||b.childNodes[0]&&(c=b.childNodes[0].nodeValue,void 0!==c))return a&&a(c),c}BulletML.build=function(b){if("string"==typeof b)var a=new DOMParser,b=h(a.parseFromString(b,"application/xml"));else if(b.getElementsByTagName("bulletml"))b=h(b);else throw Error("cannot build "+b);return b};BulletML.Root=function(){this.type="none";this.root=this;this.actions=[];this.bullets=[];this.fires=[]};BulletML.Root.prototype.findAction=
function(b){return a(this.actions,b)};BulletML.Root.prototype.findActionOrThrow=function(b){var a;if(a=this.findAction(b))return a;throw Error("action labeled '"+b+"' is undefined.");};BulletML.Root.prototype.findBullet=function(b){return a(this.bullets,b)};BulletML.Root.prototype.findBulletOrThrow=function(b){var a;if(a=this.findBullet(b))return a;throw Error("bullet labeled '"+b+"' is undefined.");};BulletML.Root.prototype.findFire=function(b){return a(this.fires,b)};BulletML.Root.prototype.findFireOrThrow=
function(b){var a;if(a=this.findFire(b))return a;throw Error("fire labeled '"+b+"' is undefined.");};BulletML.Root.prototype.getWalker=function(b,a){var c=new BulletML.Walker(this,a),d=this.findAction(b);if(d)return c._action=d,c};BulletML.Walker=function(b,a){this._root=b;this._stack=[];this._cursor=-1;this._action=null;this._localScope={};this._globalScope={$rank:a||0}};BulletML.Walker.prototype.next=function(){this._cursor+=1;if(this._action){var b=this._action.commands[this._cursor];if(b){var a=
{commandName:b.commandName};switch(b.commandName){case "action":return this.pushStack(),this._action=b,this._localScope=this.newScope(b.params),this.next();case "actionRef":return this.pushStack(),this._action=this._root.findActionOrThrow(b.label),this._localScope=this.newScope(b.params),this.next();case "repeat":return this._localScope.loopCounter=0,this._localScope.loopEnd=this.eval(b.times),this.pushStack(),this._action={commandName:"action",commands:[b.action]},this._localScope=this.newScope(b.params),
this.next();case "fire":a.bullet=b.bullet.clone(this);b.direction&&(a.direction={type:b.direction.type,value:this.eval(b.direction.value)});b.speed&&(a.speed={type:b.speed.type,value:this.eval(b.speed.value)});break;case "fireRef":return this.pushStack(),this._action={commandName:"action",commands:[this._root.findFireOrThrow(b.label)]},this._localScope=this.newScope(b.params),this.next();case "changeDirection":b.direction&&(a.direction={type:b.direction.type,value:this.eval(b.direction.value)});b.term&&
(a.term=this.eval(b.term));break;case "changeSpeed":b.speed&&(a.speed={type:b.speed.type,value:this.eval(b.speed.value)});b.term&&(a.term=this.eval(b.term));break;case "accel":b.horizontal&&(a.horizontal={type:b.horizontal.type,value:this.eval(b.horizontal.value)});b.vertical&&(a.vertical={type:b.vertical.type,value:this.eval(b.vertical.value)});b.term&&(a.term=this.eval(b.term));break;case "wait":a.value=this.eval(b.value)}return a}this.popStack();if(this._action){if((b=this._action.commands[this._cursor])&&
"repeat"==b.commandName)this._localScope.loopCounter++,this._localScope.loopCounter<this._localScope.loopEnd&&(this.pushStack(),this._action={commandName:"action",commands:[b.action]},this._localScope=this.newScope(b.params));return this.next()}}};BulletML.Walker.prototype.pushStack=function(){this._stack.push({action:this._action,cursor:this._cursor,scope:this._localScope});this._cursor=-1};BulletML.Walker.prototype.popStack=function(){var b=this._stack.pop();b?(this._cursor=b.cursor,this._action=
b.action,this._localScope=b.scope):(this._cursor=-1,this._action=null,this._localScope={})};BulletML.Walker.prototype.eval=function(b){var a;if("number"==typeof b)return b;if(isNaN(a=Number(b))){if((a=this._localScope[b])||(a=this._globalScope[b]))return a;if("$rand"==b)return Math.random()}else return a;a={};for(var c in this._globalScope)this._globalScope.hasOwnProperty(c)&&(a[c]=this._globalScope[c]);for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(a[c]=this._localScope[c]);a.$rand=
Math.random();return eval("BulletML._temp = function() { return "+b.split("$").join("this.$")+"}").bind(a)()};BulletML.Walker.prototype.newScope=function(b){var a={};if(b)for(var c=0,d=b.length;c<d;c++)a["$"+(c+1)]=this.eval(b[c]);else for(c in this._localScope)this._localScope.hasOwnProperty(c)&&(a[c]=this._localScope[c]);return a};BulletML.Bullet=function(){this.root=this.label=null;this.direction=new BulletML.Direction(0);this.speed=new BulletML.Speed(1);this.actions=[];this._localScope={}};BulletML.Bullet.prototype.getWalker=
function(b){var b=new BulletML.Walker(this.root,b),a=new BulletML.Action;a.root=this.root;a.commands=this.actions;b._action=a;b._localScope=this._localScope;return b};BulletML.Bullet.prototype.clone=function(b){var a=new BulletML.Bullet;a.label=this.label;a.root=this.root;a.actions=this.actions;a.direction={type:this.direction.type,value:b.eval(this.direction.value)};a.speed={type:this.speed.type,value:b.eval(this.speed.value)};a._localScope=b._localScope;return a};BulletML.BulletRef=function(){this.label=
this.root=null;this.params=[]};BulletML.BulletRef.prototype.clone=function(a){var c=a._localScope;a._localScope=a.newScope(this.params);var d=this.root.findBulletOrThrow(this.label).clone(a);a._localScope=c;return d};BulletML.Command=function(){this.commandName=null};BulletML.Action=function(){this.commandName="action";this.root=this.label=null;this.commands=[]};BulletML.Action.prototype=new BulletML.Command;BulletML.ActionRef=function(){this.commandName="actionRef";this.root=this.label=null;this.params=
[]};BulletML.ActionRef.prototype=new BulletML.Command;BulletML.Fire=function(){this.commandName="fire";this.bullet=this.speed=this.direction=this.root=this.label=null};BulletML.Fire.prototype=new BulletML.Command;BulletML.FireRef=function(){this.commandName="fireRef";this.label=null;this.params=[]};BulletML.FireRef.prototype=new BulletML.Command;BulletML.ChangeDirection=function(){this.commandName="changeDirection";this.direction=null;this.term=0};BulletML.ChangeDirection.prototype=new BulletML.Command;
BulletML.ChangeSpeed=function(){this.commandName="changeSpeed";this.speed=null;this.term=0};BulletML.ChangeSpeed.prototype=new BulletML.Command;BulletML.Accel=function(){this.commandName="accel";this.vertical=this.horizontal=null;this.term=0};BulletML.Accel.prototype=new BulletML.Command;BulletML.Wait=function(a){this.commandName="wait";this.value=a?a:0};BulletML.Wait.prototype=new BulletML.Command;BulletML.Vanish=function(){this.commandName="vanish"};BulletML.Vanish.prototype=new BulletML.Command;
BulletML.Repeat=function(){this.commandName="repeat";this.times=0;this.action=null};BulletML.Repeat.prototype=new BulletML.Command;BulletML.Direction=function(a){this.type="aim";this.value=a?a:0};BulletML.Speed=function(a){this.type="absolute";this.value=a?a:1};BulletML.Horizontal=function(a){this.type="absolute";this.value=a?a:0};BulletML.Vertical=function(a){this.type="absolute";this.value=a?a:0}})();(function(){function h(c){return c*Math.PI/180}function m(c){for(;c<=-Math.PI;)c+=2*Math.PI;for(;Math.PI<c;)c-=2*Math.PI;return c}function n(c,e){return Math.atan2(e.y+(e.height||0)/2-(c.y+(c.height||0)/2),e.x+(e.width||0)/2-(c.x+(c.width||0)/2))}enchant.Game._loadFuncs.bml=enchant.Game._loadFuncs.xml=function(c,e){var d=this,a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState){if(200!==a.status&&0!==a.status)throw Error(a.status+": Cannot load an asset: "+c);if(null!=a.responseXML){var f=
BulletML.build(a.responseXML);f?d.assets[c]=new enchant.bulletml.AttackPattern(f):(console.warn(c+"\u306f\u59a5\u5f53\u306aBulletML\u3067\u306f\u3042\u308a\u307e\u305b\u3093\u3002"),d.assets[c]=a.responseXML);e()}else if(null!=a.responseText)d.assets[c]=BulletML.build(a.responseText),e();else throw Error(a.status+": Cannot load an asset: "+c);}};a.open("GET",c,!0);a.overrideMimeType&&a.overrideMimeType("application/xml");a.send(null)};enchant.EventTarget.prototype.setDanmaku=function(c,e){this.on("enterframe",
c.createTicker(e))};enchant.EventTarget.prototype.removeDanmaku=function(){for(var c=[],e=this._listeners.enterframe.length;e--;)this._listeners.enterframe[e].isDanmaku&&(c[c.length]=this._listeners.enterframe[e]);for(e=c.length;e--;)this.removeEventListener("enterframe",c[e])};enchant.bulletml={};enchant.bulletml.getDefaultImage=function(){if(this.value)return this.value;var c=new enchant.Surface(8,8),e=c.context,d=e.createRadialGradient(4,4,0,4,4,4);d.addColorStop(0,"rgba(255,255,255,1.0)");d.addColorStop(0.5,
"rgba(255,255,255,1.0)");d.addColorStop(0.8,"rgba(255,  0,  0,0.8)");d.addColorStop(1,"rgba(255,  0,  0,0.0)");e.fillStyle=d;e.fillRect(0,0,8,8);return this.value=c};enchant.bulletml.DEFAULT_BULLET_FACTORY=function(){var c=new enchant.Sprite(8,8);c.image=enchant.bulletml.getDefaultImage();return c};enchant.bulletml.AttackPattern=enchant.Class.create({initialize:function(c){if(!c)throw Error("argument is invalid.",c);this._bulletml=c},_getConf:function(c){c instanceof enchant.Node&&(c={target:c});
var e={},d=enchant.bulletml.AttackPattern.defaultConfig,a;for(a in d)d.hasOwnProperty(a)&&(e[a]=d[a]);if(void 0!==c)for(a in c)c.hasOwnProperty(a)&&(e[a]=c[a]);return e},createTicker:function(c,e){if(!e&&!this._bulletml.findAction("top")){for(var d=[],a=1;this._bulletml.findAction("top"+a);a++)d[d.length]=this._createTicker(c,"top"+a);for(var f=function(){if(!f.complete){for(var a=d.length;a--;)d[a].call(this);f.compChildCount==d.length&&(f.complete=!0,this.dispatchEvent(new Event("completeAttack")))}},
a=d.length;a--;)d[a].parentTicker=f;f.compChildCount=0;f.completeChild=function(){this.compChildCount++};f.restart=function(){for(var a=d.length;a--;)d[a].restart();this.compChildCount=0;this.complete=!1};f.restart();return f}return this._createTicker(c,e)},_createTicker:function(c,e){c=this._getConf(c);if(!c.target)throw Error("not set target in config.");var d=this,a=function(){this.age<a.chDirEnd?a.direction+=a.dirIncr:this.age==a.chDirEnd&&(a.direction=a.dirFin);this.age<a.chSpdEnd?a.speed+=a.spdIncr:
this.age==a.chSpdEnd&&(a.speed=a.spdFin);this.age<a.aclEnd?(a.speedH+=a.aclIncrH,a.speedV+=a.aclIncrV):this.age==a.aclEnd&&(a.speedH=a.aclFinH,a.speedV=a.aclFinV);this.x+=Math.cos(a.direction)*a.speed*c.speedRate;this.y+=Math.sin(a.direction)*a.speed*c.speedRate;this.x+=a.speedH*c.speedRate;this.y+=a.speedV*c.speedRate;c.testInWorld(this)||this.parentNode.removeChild(this);c.updateProperties&&(this.direction=180*(a.direction+Math.PI/2)/Math.PI,this.speed=a.speed);if(!(this.age<a.waitTo||a.completed)){for(var e;e=
a.walker.next();)switch(e.commandName){case "fire":d._fire.call(this,e,c,a,d);break;case "wait":a.waitTo=this.age+eval(e.value);return;case "changeDirection":d._changeDirection.call(this,e,c,a);break;case "changeSpeed":d._changeSpeed.call(this,e,a);break;case "accel":d._accel.call(this,e,a);break;case "vanish":this.parentNode&&this.parentNode.removeChild(this)}a.completed=!0;a.parentTicker?a.parentTicker.completeChild():this.dispatchEvent(new Event("completeAttack"))}};a.restart=function(){if(void 0===
e)this.walker=d._bulletml.getWalker("top",c.rank);else if("string"===typeof e)this.walker=d._bulletml.getWalker(e,c.rank);else if(e instanceof BulletML.Bullet)this.walker=e.getWalker(c.rank);else throw Error("\u5f15\u6570\u304c\u4e0d\u6b63",c,e);this.waitTo=-1;this.completed=!1;this.dirFin=this.dirIncr=this.speedV=this.speedH=this.lastSpeed=this.speed=this.lastDirection=this.direction=0;this.chDirEnd=-1;this.spdFin=this.spdIncr=0;this.chSpdEnd=-1;this.aclFinV=this.aclIncrV=this.aclFinH=this.aclIncrH=
0;this.aclEnd=-1};a.restart();a.isDanmaku=!0;return a},_fire:function(c,e,d,a){var f=e.bulletFactory({label:c.bullet.label});if(f){var j=a.createTicker(e,c.bullet),k=this;j.direction=function(a){var b=h(eval(a.value));switch(a.type){case "aim":return e.target?n(k,e.target)+b:b-Math.PI/2;case "absolute":return b-Math.PI/2;case "relative":return d.direction+b;case "sequence":return d.lastDirection+b}}(c.direction||c.bullet.direction);d.lastDirection=j.direction;j.speed=function(a){var b=eval(a.value);
switch(a.type){case "relative":case "sequence":return d.lastSpeed+b;default:return b}}(c.speed||c.bullet.speed);d.lastSpeed=j.speed;f.x=this.x+((this.width||0)-(f.width||0))/2;f.y=this.y+((this.height||0)-(f.height||0))/2;f.addEventListener("enterframe",j);f.addEventListener("removed",function(){this.removeEventListener("enterframe",j)});e.addTarget?e.addTarget.addChild(f):this.parentNode&&this.parentNode.addChild(f)}},_changeDirection:function(c,e,d){var a=eval(c.direction.value),f=eval(c.term);
switch(c.direction.type){case "aim":c=e.target;if(!c)return;d.dirFin=n(this,c)+h(a);d.dirIncr=m(d.dirFin-d.direction)/f;break;case "absolute":d.dirFin=h(a)-Math.PI/2;d.dirIncr=m(d.dirFin-d.direction)/f;break;case "relative":d.dirFin=d.direction+h(a);d.dirIncr=m(d.dirFin-d.direction)/f;break;case "sequence":d.dirIncr=h(a),d.dirFin=d.direction+d.dirIncr*f}d.chDirEnd=this.age+f},_changeSpeed:function(c,e){var d=eval(c.speed.value),a=eval(c.term);switch(c.speed.type){case "absolute":e.spdFin=d;e.spdIncr=
(e.spdFin-e.speed)/a;break;case "relative":e.spdFin=d+e.speed;e.spdIncr=(e.spdFin-e.speed)/a;break;case "sequence":e.spdIncr=d,e.spdFin=e.speed+e.spdIncr*a}e.chSpdEnd=this.age+a},_accel:function(c,e){var d=eval(c.term);e.aclEnd=this.age+d;if(c.horizontal){var a=eval(c.horizontal.value);switch(c.horizontal.type){case "absolute":case "sequence":e.aclIncrH=(a-e.speedH)/d;e.aclFinH=a;break;case "relative":e.aclIncrH=a,e.aclFinH=(a-e.speedH)*d}}else e.aclIncrH=0,e.aclFinH=e.speedH;if(c.vertical)switch(a=
eval(c.vertical.value),c.vertical.type){case "absolute":case "sequence":e.aclIncrV=(a-e.speedV)/d;e.aclFinV=a;break;case "relative":e.aclIncrV=a,e.aclFinV=(a-e.speedV)*d}else e.aclIncrV=0,e.aclFinV=e.speedV},bulletml:{get:function(){return this._bulletml}}});enchant.bulletml.AttackPattern.defaultConfig={bulletFactory:enchant.bulletml.DEFAULT_BULLET_FACTORY,testInWorld:function(c){var e=enchant.Game.instance.width,d=enchant.Game.instance.height,a=c.height||0;return-(c.width||0)<=c.x&&c.x<e&&-a<=c.y&&
c.y<d},rank:0,updateProperties:!1,speedRate:2}})();
